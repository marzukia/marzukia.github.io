<!doctype html>

<html lang="en">

<head>
  <title>Andryo Marzuki</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Personal blog of Andryo Marzuki" />
<meta name="author" content="Andryo Marzuki" /><meta property="og:title" content="Mocking DbContext in ASP.NET Core for xUnit Tests" />
<meta property="og:description" content="Using a custom minimal JWT implementation in a ASP.NET Core WebApi rather than using the in-build Identity service." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://marzukia.github.io/posts/mocking-dbcontext-tests-aspnet/" />
<meta property="article:published_time" content="2020-06-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-06-18T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Mocking DbContext in ASP.NET Core for xUnit Tests"/>
<meta name="twitter:description" content="Using a custom minimal JWT implementation in a ASP.NET Core WebApi rather than using the in-build Identity service."/>

<meta name="generator" content="Hugo 0.69.0" />
    

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://marzukia.github.io/fontawesome/css/all.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  <link rel="stylesheet" type="text/css" href="https://marzukia.github.io/css/styles.css" /><link rel='stylesheet' href='https://marzukia.github.io'></head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="https://marzukia.github.io/">Andryo Marzuki</a>
            </h1>

      <ul id="social-media">
             <li>
               <a href="https://github.com/marzukia" title="GitHub">
               <i class="fab fa-github fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://linkedin.com/in/andryomarzuki" title="LinkedIn">
               <i class="fab fa-linkedin fa-lg"></i>
               </a>
             </li>
      </ul>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="https://marzukia.github.io/tags">
                <i class="fa-li fa  fa-lg"></i><span>Tags</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://marzukia.github.io/about/">
                <i class="fa-li fa  fa-lg"></i><span>About</span>
            </a>
        </li>
        
    </ul>
</nav>


    <main>




<article>

    <h1>Mocking DbContext in ASP.NET Core for xUnit Tests</h1>

    
      <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2020-06-18T00:00:00Z">Jun 18, 2020</time>
        </li>
        

        
        <li>
            <em>
                
                    
                    <a href="https://marzukia.github.io/tags/asp.net-core">#ASP.NET Core</a>
                
                    , 
                    <a href="https://marzukia.github.io/tags/xunit">#xUnit</a>
                
                    , 
                    <a href="https://marzukia.github.io/tags/c">#C#</a>
                
                    , 
                    <a href="https://marzukia.github.io/tags/unit-testing">#Unit Testing</a>
                
            </em>
        </li>
        

        <li>3 minutes read</li>
    </ul>
</aside>

    

    


    <p>Having unit tests in your application is important to ensure that your application functions how you intend for it to function. This is especially important as the scope and complexity of your application increases in size.</p>
<p>My starting point was this <a href="https://docs.microsoft.com/en-us/dotnet/core/testing/unit-testing-with-dotnet-test">MSDN article</a> discussing how to use xUnit with ASP.NET Core. The example itself is quite bare in my opinion, it doesn&rsquo;t actually provide any real useful examples on how to implement xUnit with your application&rsquo;s <code>DbContext</code>.</p>
<p>Mocking is the process of creating an instance of your context which you can populate with fake data, as the name suggests you are making a &lsquo;mock&rsquo; of it. By mocking your <code>DbContext</code> you are able to isolate behaviour related to your Services which call upon your database.</p>
<p><strong>Note</strong>: This is a follow up to my <a href="https://marzukia.github.io/post/aspnet-jwt-webapi/">previous article</a>, where I outlined how I implemented JWT authentication in my Web API.</p>
<h1 id="the-setup">The Setup</h1>
<p>Queue two great testing libraries: <a href="https://github.com/Moq/moq4/">Moq</a> and <a href="https://github.com/romantitov/MockQueryable">MockQueryable</a>.</p>
<div class="highlight"><pre style="color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dotnet add package Moq
dotnet add package MockQueryable.Moq
</code></pre></div><p>With these libraries installed, we can get started writing our unit tests. The steps to set up a basic unit test which uses a mocked <code>DbContext</code> is as follows:</p>
<ol>
<li>Create some fake data which we&rsquo;ll use to test</li>
</ol>
<div class="highlight"><pre style="color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#af0000">var</span> users = <span style="color:#5f8700">new</span> List&lt;ApplicationUser&gt;() {
    <span style="color:#5f8700">new</span> ApplicationUser() {
        Username = <span style="color:#00afaf">&#34;test&#34;</span>,
        Password = <span style="color:#00afaf">&#34;gw9L3AOoUxiEuKahonc17Twg47Sam64b4rm/ui/zTjU=&#34;</span>,
        Salt = Encoding
            .ASCII
            .GetBytes(<span style="color:#00afaf">&#34;\xea2858b16c8357ecb9ba6ababaa05594&#34;</span>)
    }
};
</code></pre></div><ol start="2">
<li>Convert this data into a queryable set using <code>MockQuerayble</code>.</li>
</ol>
<div class="highlight"><pre style="color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#af0000">var</span> mock = users.AsQueryable().BuildMockDbSet();
</code></pre></div><ol start="3">
<li>Create new <code>DbContext</code> taking advantage of <code>UseInMemoryDatabase()</code>. You can find more discussion about this on this <a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/testing/">MSDN article</a>.</li>
</ol>
<div class="highlight"><pre style="color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#af0000">var</span> options = <span style="color:#5f8700">new</span> DbContextOptionsBuilder&lt;UnitTestExampleContext&gt;()
    .UseInMemoryDatabase(databaseName: <span style="color:#00afaf">&#34;UserServiceTest&#34;</span>)
    .Options;

MockContext = <span style="color:#5f8700">new</span> Mock&lt;UnitTestExampleContext&gt;(options);
</code></pre></div><ol start="4">
<li>Setup our <code>MockContext</code> to map our <code>Users</code> model correctly.</li>
</ol>
<div class="highlight"><pre style="color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs">MockContext.Setup(c =&gt; c.Users).Returns(mock.Object);
</code></pre></div><ol start="5">
<li>Instantiate your <code>UserService</code> and pass through the <code>MockContext</code> into its constructor.</li>
</ol>
<div class="highlight"><pre style="color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs">_userService = <span style="color:#5f8700">new</span> UserService(MockContext.Object);
</code></pre></div><ol start="6">
<li>Write your tests!</li>
</ol>
<div class="highlight"><pre style="color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs">[Fact]
<span style="color:#5f8700">public</span> <span style="color:#5f8700">virtual</span> <span style="color:#5f8700">async</span> Task AuthenticateUser_IsValidUser_ReturnUser()
{
    <span style="color:#af0000">var</span> user = <span style="color:#5f8700">await</span> _userService
        .Authenticate(<span style="color:#00afaf">&#34;test&#34;</span>, <span style="color:#00afaf">&#34;testerday123&#34;</span>);

    Assert.True(user.GetType() == <span style="color:#5f8700">typeof</span>(User),
        <span style="color:#00afaf">&#34;Valid user did not return a User object&#34;</span>);
}
</code></pre></div><h1 id="full-working-example">Full Working Example</h1>
<div class="highlight"><pre style="color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#5f8700">using</span> System.Text;
<span style="color:#5f8700">using</span> System.Linq;
<span style="color:#5f8700">using</span> System.Collections.Generic;
<span style="color:#5f8700">using</span> System.Threading.Tasks;

<span style="color:#5f8700">using</span> Microsoft.Extensions.Options;
<span style="color:#5f8700">using</span> Microsoft.EntityFrameworkCore;

<span style="color:#5f8700">using</span> UnitTestExample.Services;
<span style="color:#5f8700">using</span> UnitTestExample.Models;

<span style="color:#5f8700">using</span> Xunit;

<span style="color:#5f8700">using</span> Moq;
<span style="color:#5f8700">using</span> MockQueryable.Moq;

<span style="color:#5f8700">namespace</span> UnitTestExample.Tests.Services
{
    <span style="color:#5f8700">public</span> <span style="color:#5f8700">class</span> <span style="color:#0087ff">UserServiceTest</span>
    {
        <span style="color:#5f8700">private</span> <span style="color:#5f8700">readonly</span> IUserService _userService;

        <span style="color:#5f8700">protected</span> Mock&lt;UnitTestExampleContext&gt; MockContext;

        <span style="color:#5f8700">public</span> UserServiceTest()
        {
            <span style="color:#af0000">var</span> users = <span style="color:#5f8700">new</span> List&lt;ApplicationUser&gt;() {
                <span style="color:#5f8700">new</span> ApplicationUser() {
                    Username = <span style="color:#00afaf">&#34;test&#34;</span>,
                    Password = <span style="color:#00afaf">&#34;gw9L3AOoUxiEuKahonc17Twg47Sam64b4rm/ui/zTjU=&#34;</span>,
                    Salt = Encoding.ASCII
                        .GetBytes(<span style="color:#00afaf">&#34;\xea2858b16c8357ecb9ba6ababaa05594&#34;</span>)
                }
            };

            <span style="color:#af0000">var</span> mock = users.AsQueryable().BuildMockDbSet();

            <span style="color:#af0000">var</span> options = <span style="color:#5f8700">new</span> DbContextOptionsBuilder&lt;UnitTestExampleContext&gt;()
                .UseInMemoryDatabase(databaseName: <span style="color:#00afaf">&#34;UserServiceTest&#34;</span>)
                .Options;

            MockContext = <span style="color:#5f8700">new</span> Mock&lt;UnitTestExampleContext&gt;(options);
            MockContext
                .Setup(c =&gt; c.Users)
                .Returns(mock.Object);

            _userService = <span style="color:#5f8700">new</span> UserService(MockContext.Object);
        }

        [Fact]
        <span style="color:#5f8700">public</span> <span style="color:#5f8700">virtual</span> <span style="color:#5f8700">async</span> Task AuthenticateUser_IsValidUser_ReturnUser()
        {
            <span style="color:#af0000">var</span> user = <span style="color:#5f8700">await</span> _userService
                .Authenticate(<span style="color:#00afaf">&#34;test&#34;</span>, <span style="color:#00afaf">&#34;testerday123&#34;</span>);

            Assert.True(user.GetType() == <span style="color:#5f8700">typeof</span>(User),
                <span style="color:#00afaf">&#34;Valid user did not return a User object&#34;</span>);
        }
    }
}
</code></pre></div><h1 id="closing-thoughts">Closing Thoughts</h1>
<p>It&rsquo;s not a hard process to set up a mocked <code>DbContext</code>, however with the lack of general documentation it can be quite confusing initially.</p>
<p>Hope I&rsquo;ve saved you some time and good luck!</p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="https://marzukia.github.io/posts/frontend-resuable-api/"><i class="fa fa-chevron-circle-left"></i> Using Fetch over Axios in ReactJS Applications</a>
        </li>
        
        
    </ul>
</section>
  
    
    
        <section class="comments-block">
      <button id="show-comments" style="display: none;"><i class="fa fa-comments"></i> Add/View Comments</button>
</section>

<section id="disqus_thread"></section>

<script>
      (function () {
            
            
            if (window.location.hostname == "localhost")
                  return;

            var disqus_loaded = false;
            var disqus_shortname = 'marzukia';
            var disqus_button = document.getElementById("show-comments");

            var disqus_autoload =  null ;
            var disable_comment =  null ;

            if (disable_comment)
                  return;

            disqus_button.style.display = "";

            if (disqus_autoload){
                  disqus();
            }else{
                  disqus_button.addEventListener("click", disqus, false);
            }

            function disqus() {

                  if (!disqus_loaded) {
                        disqus_loaded = true;

                        var e = document.createElement("script");
                        e.type = "text/javascript";
                        e.async = true;
                        e.src = "//" + disqus_shortname + ".disqus.com/embed.js";
                        (document.getElementsByTagName("head")[0] ||
                              document.getElementsByTagName("body")[0])
                        .appendChild(e);

                        
                        document.getElementById("show-comments").style.display = "none";
                  }
            }

            
            var hash = window.location.hash.substr(1);
            if (hash.length > 8) {
                  if (hash.substring(0, 8) == "comment-") {
                        disqus();
                  }
            }

            
            if (/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)) {
                  disqus();
            }
      })();
</script>

    
  





</main>
    <footer>
        <h6>© 2020, Andryo Marzuki |
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="https://marzukia.github.ioindex.xml">Subscribe </a></h6>
    </footer>
</div>
<script src="https://marzukia.github.io/js/scripts.js"></script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-170171726-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>

